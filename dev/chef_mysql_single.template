heat_template_version: 2013-05-23

description: |
  Configures a cloud server with chef-solo

parameters:
  keypair_name:
    type: String
    required: true

  stack_id:
    type: String
    required: true
    default: "noop"

  mysql_server_flavor:
    type: String
    required: true
    default: "2"

  mysql_server_name:
    type: String
    required: true
    default: "noop"

  mysql_root_password:
    type: String
    required: true
    default: "verybadpass123"

  database_name:
    type: String
    default: "noop"

  database_username:
    type: String
    required: true
    default: "noop"

  database_password:
    type: String
    required: true
    default: "verybadpass123"

resources:
    ssh_key:
        type: "OS::Nova::KeyPair"
        properties:
            name: {get_param: keypair_name}
            save_private_key: true

    mysql_server:
        type: "Rackspace::Cloud::Server"
        properties:
            flavor: {get_param: mysql_server_flavor}
            image: 23b564c9-c3e6-49f9-bc68-86c7a9ab5018
            name: { get_param: mysql_server_name }
            key_name: {Ref: ssh_key}

    install_apt:
        type: "OS::Heat::ChefSolo"
        properties:
            username: root
            private_key: {get_attr: [ssh_key, private_key]}
            host: {get_attr: [mysql_server, PublicIp]}
            Berksfile: |
                site :opscode
                cookbook 'apt',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'apt'
            node:
                run_list: ["recipe[apt]"]

    install_make:
        type: "OS::Heat::ChefSolo"
        DependsOn: install_apt
        properties:
            username: root
            private_key: {get_attr: [ssh_key, private_key]}
            host: {get_attr: [mysql_server, PublicIp]}
            Berksfile: |
                site :opscode
                cookbook 'build-essential'
            node:
                run_list: ["recipe[build-essential]"]

    mysql_config: 
        type: "OS::Heat::ChefSolo"
        DependsOn: install_make
        properties:
            username: root
            private_key: {get_attr: [ssh_key, private_key]}
            host: {get_attr: [mysql_server, PublicIp]}
            Berksfile: |
                site :opscode
                cookbook 'build-essential'
                cookbook 'chef-client'
                cookbook 'chef-solo-search'
                cookbook 'apt',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'apt'
                 cookbook 'firewall',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'firewall'                   
                 cookbook 'mysql',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'checkmate-solo-mysql'                   
                cookbook 'holland',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'holland'
                cookbook 'monit',
                    git: 'github_heat_cookbooks:rackerlabs/heat-cookbooks.git',
                    rel: 'monit'
            node:
                deployment:
                    id: {get_param: stack_id}
                mysql:
                    server_root_password: {get_param: mysql_root_password}
                run_list: [
                    "recipe[build-essential]",
                    "recipe[apt]",
                    "recipe[chef-solo-search]",
                    "recipe[firewall]",
                    "recipe[mysql::server]",
                    "recipe[holland]",
                    "recipe[holland::common]",
                    "recipe[holland::mysqldump]",
                    "recipe[monit]"]

            data_bags:
                mysql: 
                    encrypted: true
                    id: {get_param: stack_id}
                    mysql:
                        database_name: {get_param: database_name}

outputs:
    private_key:
        value: {get_attr: [ssh_key, private_key]}
