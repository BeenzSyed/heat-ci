heat_template_version: 2013-05-23

description: |
  Test template for Trove resource capabilities

parameters:
  db_pass:
    type: string
    hidden: true
    description: Database access password
    default: secrete

  devops_flavor:
    type: string
    description: Flavor name for the devops server
    default: 4 GB Performance
    constraints:
    - allowed_values:
      - 4 GB Performance
      - 4GB Standard Instance

  test_server_name:
    description: base name for the server instances
    type: string
    default: Trove Tester 

resources:

  random_key_name:
    type: OS::Heat::RandomString
    properties:
      length: 8

  access_key:
    type: OS::Nova::KeyPair
    properties:
      name: { get_resource: random_key_name }
      save_private_key: true

  priv_network:
    type: Rackspace::Cloud::Network
    properties:
      label: kitchen_sink
      cidr: 192.168.0.0/24

  service_nodes:
    type: OS::Heat::ResourceGroup
    depends_on: service_db
    properties:
      count: 2
      resource_def:
        type: OS::Nova::Server
        properties:
          name: "service_engine_%index%"
          image: 6f29d6a6-9972-4ae0-aa80-040fa2d6a9cf # Ubuntu 14.04 LTS (Trusty Tahr) (PVHVM)
          flavor: { get_param: devops_flavor }
          key_name: { get_resource: access_key }
          networks:
          - uuid: { get_resource: priv_network }
          - uuid: "00000000-0000-0000-0000-000000000000"
          - uuid: "11111111-1111-1111-1111-111111111111"
          user_data: |
            #!/bin/bash -x
            echo "hello world" > /root/hello-world.txt

  service_lb:
    type: "Rackspace::Cloud::LoadBalancer"
    properties:
      name:
        str_replace:
          template: "lb-%server_name%"
          params:
            "%server_name%": { get_param: test_server_name }
      nodes:
      - addresses: { get_attr: [ service_nodes, accessIPv4 ] }
        port: 80
        condition: ENABLED
      protocol: HTTP
      halfClosed: False
      algorithm: LEAST_CONNECTIONS
      connectionThrottle:
        maxConnections: 50
        minConnections: 50
        maxConnectionRate: 50
        rateInterval: 50
      port: 80
      timeout: 120
      sessionPersistence: HTTP_COOKIE
      virtualIps:
      - type: PUBLIC
        ipVersion: IPV4
      healthMonitor:
        type: HTTP
        delay: 10
        timeout: 10
        attemptsBeforeDeactivation: 3
        path: "/"
        statusRegex: "."
        bodyRegex: "."
      contentCaching: ENABLED

  service_db:
    type: OS::Trove::Instance
    properties:
      name: trove_test_db
      flavor: 1GB Instance
      size: 10
      databases:
      - name: test_data
      users:
      - name: kitchen_sink
        password: { get_param: db_pass }
        databases: [ test_data ]

  db_replica:
    type: OS::Trove::Instance
    properties:
      name: trove_test_db_replica
      flavor: 2GB Instance
      size: 5
      datastore_type: mariadb
      replica_of: { get_resource: service_db }

outputs:

  "Private Network ID":
    value: { get_resource: priv_network }
    description: Private Network ID

  "Random String":
    value: { get_attr: [ random_key_name, value ] }
    description: Random String

  "Access Private Key":
    value: { get_attr: [ access_key, private_key ] }
    description: SSH access private key

  "DB ID":
    value: { get_resource: service_db }
    description: Database instance ID

  "Service Node IDs":
    value: { get_attr: [ service_nodes, refs ] }
    description: Engine Node IDs

  "Load Balancer ID":
    value: { get_resource: service_lb }
    description: Load Balancer ID

  "Load Balancer IP":
    value: { get_attr: [ service_lb, PublicIp ] }
    description: Load Balancer IP
